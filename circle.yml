machine:
  node:
    version: 6.1
  environment:
    _JAVA_OPTIONS: "-Xmx512m -XX:MaxPermSize=128M"
    REPO_NAME: "cplace-quinscape-workshop"
  java:
    version: oraclejdk8

#  pre:
#    - FILE=$CIRCLE_ARTIFACTS/memory-usage-actual.txt; while true; do ps -u ubuntu eo pid,%cpu,%mem,args,uname --sort=-%mem >> $FILE; echo "----------" >> $FILE; sleep 1; done: # note the colon here
#        background: true

# When you add another parent repo, also update the cache_directories below!

dependencies:
  cache_directories:
      - "/home/ubuntu/main/.git"
      - "/opt/circleci/nodejs/v6.1.0/bin"
      - "/opt/circleci/nodejs/v6.1.0/lib/node_modules"
  pre:
    - npm install -g @cplace/cli
    - mkdir -p /home/ubuntu/target/software
    - git reset --hard
    - echo "clone missing parent repos"; cd /home/ubuntu/$CIRCLE_PROJECT_REPONAME && cplace-cli repos --clone --verbose --force
    - echo "updating parent repos"; cd /home/ubuntu/$CIRCLE_PROJECT_REPONAME && cplace-cli repos --update --verbose --force
    - echo "freezing parent repos"; cd /home/ubuntu/$CIRCLE_PROJECT_REPONAME && cplace-cli repos -w --freeze --verbose --force

test:
  override:
    - ant test-or-build -Dsoftware-dir=/home/ubuntu/target/software -Dcplace.store.hsqldb.useFile=false :
        parallel: true
